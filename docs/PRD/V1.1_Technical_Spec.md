# V1.1 技术规格文档 - 完整牌局模拟训练

## 1. 数据模型

### 1.1 FullHandSession (完整牌局会话)
```python
class FullHandSession(Base):
    id: int (PK)
    user_id: int (FK)
    
    # 配置
    table_type: str = "6max"
    stack_bb: int = 100
    ai_level: str = "standard"
    
    # 随机种子 (用于重打)
    hand_seed: str
    
    # 牌局状态
    status: str  # INIT, PREFLOP, FLOP_DECISION, FAST_FORWARD, ENDED
    current_street: str  # preflop, flop, turn, river
    
    # 牌局数据 (JSON)
    players: List[PlayerState]
    button_seat: int
    sb_seat: int
    bb_seat: int
    pot: float
    current_bet: float
    community_cards: List[str]  # 公共牌
    action_log: List[ActionRecord]
    
    # Hero 相关
    hero_seat: int
    hero_cards: List[str]
    
    # 关键点
    preflop_key_spot: Optional[KeySpotRecord]
    flop_key_spot: Optional[KeySpotRecord]
    
    # 结果
    result_bb: float  # +/- bb
    ended_by: str  # fold, showdown, allin
    
    # 时间戳
    created_at: datetime
    completed_at: Optional[datetime]
```

### 1.2 PlayerState (玩家状态)
```python
class PlayerState:
    seat: int
    position: str  # UTG, MP, CO, BTN, SB, BB
    stack: float
    in_hand: bool
    committed_this_street: float
    total_committed: float
    hole_cards: Optional[List[str]]  # 仅 Hero 可见
    is_hero: bool
    is_active: bool  # 本轮是否还能行动
```

### 1.3 ActionRecord (行动记录)
```python
class ActionRecord:
    street: str
    seat: int
    position: str
    action: str  # fold, check, call, bet, raise, allin, sb, bb
    amount: Optional[float]
    pot_after: float
    timestamp: datetime
```

### 1.4 KeySpotRecord (关键点记录)
```python
class KeySpotRecord:
    street: str  # preflop, flop
    context_id: str
    pot_type: Optional[str]  # SRP, 3BP, 4BP (仅 flop)
    ip_oop: Optional[str]  # IP, OOP (仅 flop)
    spr_bucket: Optional[str]  # LOW, MED, HIGH
    board: Optional[List[str]]  # 仅 flop
    hero_hand: str
    hero_hand_bucket: Optional[str]  # made_strong, made_medium, made_weak, draw_strong, draw_weak, air
    
    legal_actions: List[str]
    strategy: Dict[str, float]  # 动作 -> 概率
    
    user_action: Optional[str]
    user_action_prob: Optional[float]
    best_action: str
    grade: Optional[str]  # PERFECT, ACCEPTABLE, WRONG
```

## 2. 牌局引擎状态机

```
INIT 
  → 发牌、设置盲注 → PREFLOP

PREFLOP
  → Hero 决策点 → PREFLOP_HERO_DECISION
  → AI 自动行动 → 继续 PREFLOP
  → Hero 弃牌 → ENDED
  → 进入翻牌 → FLOP

PREFLOP_HERO_DECISION
  → 用户行动 → 更新状态 → PREFLOP
  → 记录关键点

FLOP
  → 确定是否为关键点场景 → FLOP_KEYSPOT_CHECK
  
FLOP_KEYSPOT_CHECK
  → 是关键点 → FLOP_DECISION
  → 非关键点 → FAST_FORWARD
  
FLOP_DECISION
  → 用户决策 → FAST_FORWARD
  → 记录关键点
  
FAST_FORWARD
  → AI 自动完成 Turn/River → SHOWDOWN/ENDED
  
SHOWDOWN/ENDED
  → 结算 → REVIEW
```

## 3. API 接口

### 3.1 POST /api/v1/fullhand/start
启动一局完整牌局

Request:
```json
{
  "table_type": "6max",
  "stack_bb": 100,
  "ai_level": "standard",
  "replay_seed": null  // Pro 重打时使用
}
```

Response:
```json
{
  "hand_id": 123,
  "state": {
    "status": "PREFLOP",
    "street": "preflop",
    "players": [...],
    "button_seat": 0,
    "sb_seat": 1,
    "bb_seat": 2,
    "pot": 1.5,
    "current_bet": 1.0,
    "community_cards": [],
    "to_act_seat": 3,
    "hero_seat": 4,
    "hero_cards": ["Ah", "Kh"]
  },
  "legal_actions": ["fold", "call", "raise"],
  "action_log": [...],
  "is_key_spot": false
}
```

### 3.2 POST /api/v1/fullhand/act
执行动作

Request:
```json
{
  "hand_id": 123,
  "action": "raise",
  "amount": 2.5  // 对于 bet/raise 需要
}
```

Response:
```json
{
  "state": {...},
  "legal_actions": [...],
  "is_key_spot": true,  // 是否进入翻牌关键点
  "key_spot_info": {
    "street": "flop",
    "context_id": "FLOP_SRP_BTNvBB_IP_PFR_CBET",
    "pot_type": "SRP",
    "board": ["7h", "8s", "2d"]
  },
  "final_result": null,  // 如果游戏结束则有值
  "review_payload": null
}
```

### 3.3 GET /api/v1/fullhand/review?hand_id=123
获取复盘数据

Response (Pro):
```json
{
  "hand_id": 123,
  "result_bb": 5.2,
  "ended_by": "showdown",
  "action_log": [...],
  "preflop_spot": {
    "context_id": "RFI_BTN",
    "strategy": {"fold": 0, "call": 0, "raise": 1.0},
    "user_action": "raise",
    "user_action_prob": 1.0,
    "grade": "PERFECT"
  },
  "flop_spot": {
    "context_id": "FLOP_SRP_BTNvBB_IP_PFR_CBET",
    "pot_type": "SRP",
    "ip_oop": "IP",
    "spr_bucket": "HIGH",
    "board": ["7h", "8s", "2d"],
    "hero_hand": "AhKh",
    "hero_hand_bucket": "air",
    "strategy": {
      "check": 0.35,
      "bet33": 0.40,
      "bet75": 0.20,
      "bet125": 0.05
    },
    "legal_actions": ["check", "bet33", "bet75", "bet125"],
    "user_action": "bet75",
    "user_action_prob": 0.20,
    "best_action": "bet33",
    "grade": "ACCEPTABLE",
    "explanation": "该纹理下进攻方高频小尺度下注"
  }
}
```

Response (Free) - 裁剪版:
```json
{
  "hand_id": 123,
  "result_bb": 5.2,
  "ended_by": "showdown",
  "flop_spot": {
    "context_id": "FLOP_SRP_BTNvBB_IP_PFR_CBET",
    "board": ["7h", "8s", "2d"],
    "hero_hand": "AhKh",
    "best_action": "bet33",
    "user_action": "bet75",
    "grade": "ACCEPTABLE"
    // 无 strategy 分布，无 user_action_prob
  }
}
```

### 3.4 POST /api/v1/fullhand/replay
重打同一手 (Pro)

Request:
```json
{
  "hand_id": 123
}
```

Response: 同 start

## 4. 策略引擎

### 4.1 翻牌策略简化实现

由于不是完整 solver，使用基于规则的简化策略：

**输入特征计算:**
1. **potType**: 根据翻前行动历史判断 (SRP/3BP/4BP)
2. **ipOop**: Hero 相对于最后下注者的位置
3. **sprBucket**: 
   - LOW: SPR < 3
   - MED: 3 <= SPR <= 6  
   - HIGH: SPR > 6
4. **boardTexture**:
   - dry: 如 K72 彩虹面
   - wet: 如 9TJQ 两高张连张
   - paired: 有对子
   - monotone: 单色
5. **heroHandBucket**:
   - 根据手牌牌力计算

**策略输出规则:**
基于上述特征，使用预设的策略矩阵（类似现有 GTO 引擎的简化版）

### 4.2 下注尺度计算

```python
def calculate_bet_size(pot: float, scale: float, min_bet: float = 0.5) -> float:
    """
    pot: 当前底池
    scale: 0.33, 0.75, 1.25
    """
    amount = pot * scale
    # 取整到 0.5bb
    amount = math.floor(amount * 2) / 2
    # 确保不小于最小下注
    return max(amount, min_bet)
```

## 5. 快进引擎

当 Hero 完成翻牌决策后，系统自动执行:
1. 根据双方手牌和策略采样 Turn/River 行动
2. 遇到下注/加注时根据策略决定是否跟注/弃牌
3. 直到摊牌或一方弃牌
4. 计算胜负和筹码变化

## 6. 权限控制

### Free 用户
- 每日额度: 10 局 (与情景题共享或独立)
- 复盘: 仅显示推荐动作，不显示频率分布
- 不能重打同一手

### Pro 用户
- 无限局数
- 复盘: 显示完整频率分布、偏离度
- 支持重打同一手 (固定 seed)

## 7. 埋点事件

```python
# 开始一局
fullhand_start: {
    hand_id, table_type, stack_bb, ai_level, 
    user_is_pro, hand_seed
}

# 每次 Hero 行动
fullhand_hero_action: {
    hand_id, street, context_id, action, amount,
    pot, to_call, response_time_ms
}

# 生成关键点
fullhand_keyspot_generated: {
    hand_id, street, context_id, strategy_hash
}

# 结束一局
fullhand_end: {
    hand_id, result_bb, ended_by, 
    streets_reached, duration_ms
}

# 查看复盘
fullhand_review_view: {
    hand_id, shown_preflop, shown_flop
}

# 重打
fullhand_replay_same_hand: {
    original_hand_id, new_hand_id
}
```
