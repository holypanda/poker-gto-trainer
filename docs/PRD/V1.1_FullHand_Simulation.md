# 完整 PRD（模块更新）｜V1.1「完整牌局模拟训练（版本 A）」  
> 版本：V1.1（新增模块）  
> 范围：**完整翻前流程 + 翻牌仅 1 个 Hero 关键决策点**；后续回合由系统自动快进结算（模拟对局收尾），用于**加速训练**  
> 桌型：**6max**  
> 翻后下注尺度：**3 个（33% / 75% / 125% pot）**  
> 反馈风格：**偏数据化频率（Pro 展示混合频率/分布）**  
> 商业：不改变订阅与支付（沿用 1 元/月、支付宝）

---

## 1. 背景与目标

### 1.1 背景
现有产品以翻前情景题为主（spot 训练），能高密度覆盖范围，但缺少"真实牌局上下文"与"行动链路"。用户学习的策略难以迁移到真实对局，且训练趣味与沉浸感有限。

### 1.2 目标
新增"完整牌局模拟训练"模块，让用户在 6max 桌上经历**完整翻前行动序列**，并在翻牌遇到一个关键决策点进行选择；系统基于策略库给出**频率型复盘**，并通过**重打与相似局面聚焦**提升训练速度。

### 1.3 非目标（V1.1 不做）
- 不做全街（Turn/River）多次 Hero 决策（版本 B 延后）
- 不做真实多人翻后复杂博弈与 solver 级精确
- 不做自定义对手形象/聊天/真实牌桌社交
- 不做可提现竞技、排行榜、反作弊体系

---

## 2. 用户画像与使用场景

### 2.1 目标用户
- 已了解德扑基础规则，能进行翻前范围学习的人
- 希望从"背范围"过渡到"实战线"训练的人
- 订阅 Pro 用户（更关注频率、混合策略、数据统计）

### 2.2 核心场景
- 场景 A：用户每天训练 20–50 手，提升翻前线的熟练度与翻牌第一决策（c-bet / 防守 vs c-bet）
- 场景 B：用户复盘后，重打同一手（同公共牌）快速修正决策
- 场景 C：从完整牌局引导回情景题专项（对弱点 spot 加速补课）

---

## 3. 体验概述（用户流程）

### 3.1 入口与模式选择
首页新增入口卡片：**「完整牌局模拟」**  
进入后默认配置：
- 桌型：6max
- 深度：100bb（可切 50bb/100bb，若现有已支持）
- AI 难度：标准（若 V1.1 只做单档也可）
- 节奏：快速（动画可切换）

点击 **「开始一局」** → 进入牌桌。

### 3.2 一局流程（版本 A）
1) 发牌、盲注、确定按钮位  
2) **翻前完整行动**：AI 与 Hero 按规则行动，直到：
   - Hero 弃牌 → 立即结算（本局结束）
   - 或形成翻牌底池（可能是 SRP/3BP/4BP 等，视翻前情况）  
3) 发出翻牌（3 张公共牌）  
4) **翻牌：仅出现 1 次 Hero 决策**（关键点），用户选择：Fold/Check/Call/Bet/Raise（取决于合法动作）  
5) 用户做出选择后：
   - 系统用对手策略补全对局至终局（Turn/River 自动快进），并生成最终结果（弃牌或摊牌）  
6) 进入复盘页：展示 1 个翻牌关键点（必有）+ 可选翻前关键点（可配置，见 8.2）

> 训练加速点：用户每局只做"最重要"的一个翻牌决策，单位时间手数更高。

---

## 4. 功能范围（V1.1）

### 4.1 新增模块功能清单
- 完整牌局模拟（6max）：发牌、盲注、行动顺序、筹码与底池结算
- 翻前策略驱动（沿用你现有 spot/范围体系）
- 翻牌单决策点生成、动作合法性与下注尺度（33/75/125% pot）
- 对手翻后（翻牌起）策略执行与自动快进
- 数据化复盘（频率/推荐动作/偏离度）与一键重打
- 埋点与统计（用于后续"弱点聚焦"）

### 4.2 权益（Free/Pro）
- **Free**
  - 每日完整牌局：例如 10 局/天（可由你现有策略决定；也可与情景题共享"今日额度"）
  - 复盘：仅显示**主推荐动作**与简短数据（不展示混合频率分布）
- **Pro（1 元/月）**
  - 不限局数
  - 复盘展示：**动作混合频率分布 + 你所选动作的概率/偏离度**
  - "固定随机种子重打同一手"（同翻前行动+同翻牌）开关

> 不新增新的付费档；沿用支付宝订阅链路。

---

## 5. 核心规则与引擎（状态机）

### 5.1 牌局状态机（必做）
状态：
- `INIT` → `PREFLOP` → `FLOP_DECISION` → `FAST_FORWARD` → `SHOWDOWN/END` → `REVIEW`

关键数据结构（建议）：
- `players[6]`: seat、position、stack、inHand、committedThisStreet、totalCommitted、holeCards(仅 hero 真实展示)、isHero
- `buttonSeat`, `sbSeat`, `bbSeat`
- `pot`: main pot（V1.1 可只做主池；如要支持全下边池，需额外 `sidePots[]`）
- `street`: preflop/flop/turn/river
- `toActSeat`
- `currentBet`（本街最高投入）
- `minRaiseTo`（最小加注到多少）
- `actionLog[]`

### 5.2 行动合法性（必须严格）
- Fold：仅在面对下注/加注时
- Check：仅当 `committedThisStreet == currentBet`
- Call：补齐至 `currentBet`（不得超过 stack）
- Bet：仅当 `currentBet == 0`，金额按尺度 = pot * x（并满足最小下注规则）
- Raise：仅当面对下注/加注，金额按规则（例如到 `currentBet + raiseSize`），并满足最小加注
- All-in：当按钮金额≥stack 或用户点 all-in

> V1.1 为降低复杂度：允许在翻牌决策点只提供"能合法的按钮集合"，并对不合法动作完全隐藏。

### 5.3 下注尺度（翻牌）
当 Hero 在翻牌有 bet/raise 权限时，展示（按 pot 比例）：
- 33% pot
- 75% pot
- 125% pot

实现细则：
- 计算基于**当前底池**（含已投入但未进入 pot 的需要统一口径，建议以"可见底池 potSize"作为基准）
- 金额取整：以最小筹码单位（例如 0.5bb 或 1）向下取整，并确保不小于最小下注/加注
- 若尺度导致金额 ≥ Hero stack，则按钮显示为 All-in（或仍显示 125% 但文案标注 All-in）

---

## 6. 策略系统（AI 与评分的统一接口）

### 6.1 翻前策略（沿用现有体系）
输入：
- 位置（UTG/MP/CO/BTN/SB/BB）
- 动作历史（RFI / Facing RFI / Facing 3bet / Facing 4bet / Squeeze 等）
- 有效筹码深度（50bb/100bb）
- Hero 手牌（169 类或具体牌）

输出：
- 动作概率分布：`{fold, call, raise(sizeId...)}` 或你现有 `p_fold/p_call/p_raise`

对手执行：
- 按概率采样（可用 `rngSeed` 复现）
- size 使用固定策略（与你现有 preflop sizing 一致）

### 6.2 翻牌策略（新增，版本 A）
#### 6.2.1 翻牌决策点选择（只生成 1 个 Hero 点）
规则：当进入翻牌后，系统在以下两类中选其一（优先顺序可配置）：

1) **Hero 为翻前进攻方**（PFR）且在翻牌轮到 Hero 首次可下注时：训练 `c-bet`（check vs bet(33/75/125))  
2) **Hero 为翻前防守方**且面对对手翻牌下注：训练 `vs c-bet`（fold/call/raise(尺度))

若翻牌无法形成上述场景（比如 Hero 已弃牌、或翻前全下无翻牌、或多方特殊情况），则：
- 直接结算/复盘（只做翻前复盘）
- 或重新发一手（推荐：**重新发一手**以保证翻牌决策产出率）

> 目标：翻牌决策产出率 ≥ 85%。

#### 6.2.2 翻牌策略输出形式（用于 AI 执行 + 用于评分）
输入特征（最小集合）：
- `potType`: SRP/3BP/4BP
- `heroPosition`: IP/OOP（相对对手）
- `sprBucket`: 低/中/高（例如 <3, 3–6, >6）
- `boardTexture`: dry / wet / paired / monotone 等（可多标签）
- `heroHandBucket`: made(强/中/弱)、draw(强/弱)、air（由牌力与听牌规则映射）

输出：
- 合法动作集合上的概率分布，如：
  - 进攻方：`{check:0.35, bet33:0.40, bet75:0.20, bet125:0.05}`
  - 防守方：`{fold:0.22, call:0.61, raise75:0.12, raise125:0.05}`

> 这不是 solver，但形式上与 solver 输出一致，便于"频率化复盘"。

### 6.3 自动快进（FAST_FORWARD）
当 Hero 完成翻牌 1 次决策后：
- 后续街道的所有行动由 AI 自动完成
- 允许：
  - 任何一方弃牌 → 立即结束
  - 摊牌 → 评估胜负并结算筹码变化
- 快进期间依然记录完整 actionLog（用于复盘展示最终线，但不对 Hero 再评分）

---

## 7. 复盘与评分（偏数据化频率）

### 7.1 关键指标定义
- **推荐动作（Best Action）**：概率最高的动作（mode）
- **混合频率（Mix）**：各动作概率分布（Pro 展示）
- **偏离度（Deviation）**：\(1 - p(\text{userAction})\) 或更细：与最优动作概率差
- **评级**（建议沿用你现有阈值）：
  - Perfect：\(p \ge 0.60\)
  - Acceptable：\(0.20 \le p < 0.60\)
  - Wrong：\(p < 0.20\)

> 阈值可配置，不写死在前端。

### 7.2 V1.1 复盘内容（每局）
#### 7.2.1 必有：翻牌关键点复盘
展示项：
- 场景摘要：位置、底池类型（SRP/3BP）、SPR 桶、翻牌牌面
- 你选择的动作与下注额
- **Pro：动作频率条形图/表格**（check / bet33 / bet75 / bet125 或 fold/call/raise…）
- 你的动作概率 \(p\) 与评级
- 简短解释（1–2 条，偏数据事实，而非长教学）：
  - "该纹理下进攻方高频小尺度下注"
  - "该手牌 bucket 在此线里主要以 call 保留对手 bluff"

#### 7.2.2 可选：翻前关键点复盘（建议开启）
为了强化"完整牌局"价值，V1.1 建议在翻前也抽取最多 1 个关键点（若有 Hero 决策）：
- 例如 Facing RFI 时的 3bet/call/fold
- 或面对 3bet 的 4bet/call/fold

展示形式与阈值沿用现有翻前逻辑：
- Free：仅显示推荐动作
- Pro：显示 `fold/call/raise` 概率（若你现有数据有）

> 若你担心复盘太长，可设置：翻前只有当用户选择 "Wrong" 才提示。

### 7.3 一键重打（加速训练核心）
- Pro 功能：**"重打同一手"**  
  - 固定：Hero 手牌 + 翻牌（以及翻前行动序列）  
  - 允许用户改动作，比较评分与结果  
- Free：可"再来一手"（不保证相同）

实现：在 `handSeed` 基础上派生 `dealSeed`、`actionSeed`，保证可复现。

---

## 8. UI/交互 PRD

### 8.1 牌桌主界面（移动端优先，Web 兼容）
模块组成：
1) **桌面区**：6 座位、按钮位标识、筹码、弃牌灰态  
2) **公共信息**：底池 Pot、当前街道、当前下注额、Hero 需跟注金额  
3) **公共牌区**：翻牌展示（turn/river 快进阶段可快速闪过或只在结算页展示完整 5 张）  
4) **行动日志**：一行横向可滚动（例如 `UTG fold · MP open 2bb · ...`)  
5) **操作面板**（仅轮到 Hero 时出现）
   - Fold / Check / Call
   - Bet 或 Raise：点击弹出 33/75/125% 三按钮（显示对应金额）

交互规则：
- 非 Hero 回合：操作面板隐藏/禁用
- 快进阶段：显示"快进中…"与最终结果按钮
- 动画：可开关（默认快）

### 8.2 复盘界面（数据化）
卡片结构（从上到下）：
- 本局结果：+/- bb、是否摊牌、最终牌力（可选）
- 翻牌关键点卡片：
  - 场景摘要（SRP/3BP、IP/OOP、SPR、board tags）
  - 频率图（Pro）
  - 你选动作标记（Pro）
  - 推荐动作（所有用户）
- （可选）翻前关键点卡片
- 按钮：
  - Pro：重打同一手
  - 全部：再来一局
  - 全部：去练相似局面（跳转到情景题模块的 spot_id）

---

## 9. 与现有系统的集成

### 9.1 账号/订阅
- 复用现有鉴权、订阅校验（支付宝订阅状态）
- 在接口层做权限裁剪：局数额度、复盘深度、重打功能

### 9.2 训练体系联动
- 从完整牌局复盘生成 `spot_hint`：
  - 翻前：直接用已有 spot_id
  - 翻牌：生成 `flop_context_id`（新）并可映射到"翻牌专项"（未来）
- "去练相似局面"：
  - 翻前：跳到现有翻前训练的 spot
  - 翻牌：V1.1 可先跳到一个"翻牌训练 Coming soon / 或提示继续刷完整牌局"页面；如果你已准备翻牌专项，也可直接跳转

---

## 10. 数据埋点与统计

### 10.1 埋点事件（新增）
- `fullhand_start`
  - table=6max, stack=50/100, user_is_pro, ai_level, hand_seed
- `fullhand_end`
  - result_bb, ended_by=fold/showdown/allin, streets_reached, duration_ms
- `fullhand_hero_action`
  - street=preflop/flop, context_id(spot_id 或 flop_context_id), action, size, pot, to_call
- `fullhand_keyspot_generated`
  - street, context_id, legal_actions, strategy_probs(hash), chosen_by_user
- `fullhand_review_view`
  - shown_preflop_spot=true/false, shown_flop_spot=true/false
- `fullhand_replay_same_hand`
  - enabled=true/false, replay_count

### 10.2 指标看板（V1.1 建议）
- 完整牌局日/周局数、人均时长
- 翻牌关键点正确率（按 Perfect/Acceptable/Wrong）
- 最常错翻前 spot Top N
- Pro vs Free 的使用差异（复盘打开率、重打次数）

---

## 11. 服务端接口（建议草案）

> 关键原则：**对手策略与评分在服务端**，前端仅展示与提交动作，避免策略泄露与可篡改。

### 11.1 开始一局
`POST /api/fullhand/start`
- req: `{ tableType:"6max", stackBB:100, aiLevel:"standard", replaySeed?:string }`
- resp:  
  - `handId`
  - `state`: seats、button、blinds、heroCards(仅 hero)、stacks、pot、toAct、street
  - `legalActions`（如果立刻轮到 hero）
  - `actionLog`

### 11.2 Hero 行动
`POST /api/fullhand/act`
- req: `{ handId, actionType:"fold|check|call|bet|raise|allin", size?:number }`
- resp:
  - 更新后的 `state`
  - 若进入翻牌关键点：返回 `isKeySpot=true` + `legalActions`
  - 若 hero 完成翻牌决策：服务端执行快进并返回 `finalResult` 与 `reviewPayload`

### 11.3 获取复盘（便于重进）
`GET /api/fullhand/review?handId=...`
- resp: `reviewPayload`（含策略分布、用户动作概率、评级等；Free 会被裁剪）

### 11.4 重打同一手（Pro）
`POST /api/fullhand/replay`
- req: `{ handId }`
- resp: 新 `handId`，但复用同 `replaySeed`

---

## 12. 策略与评分数据结构（reviewPayload）

### 12.1 翻牌关键点（示例结构）
```json
{
  "spotType": "FLOP_KEYSPOT",
  "contextId": "FLOP_SRP_BTNvBB_IP_PFR_CBET",
  "street": "flop",
  "potType": "SRP",
  "ipOop": "IP",
  "sprBucket": "MED",
  "board": ["Ah", "7d", "2c"],
  "heroHand": "KQs",
  "legalActions": ["check", "bet33", "bet75", "bet125"],
  "strategy": {
    "check": 0.31,
    "bet33": 0.47,
    "bet75": 0.18,
    "bet125": 0.04
  },
  "userAction": "bet75",
  "pUserAction": 0.18,
  "grade": "ACCEPTABLE",
  "bestAction": "bet33"
}
```

### 12.2 Free 裁剪规则
- `strategy` 仅保留 `bestAction` 或只给 top1/top2（不暴露完整分布）
- `pUserAction` 可隐藏或仅给等级

---

## 13. 边界条件与异常处理

- **翻前全下**：无需翻牌，直接结算并给翻前复盘
- **Hero 翻前弃牌**：立即结束；可给翻前关键点复盘
- **多人底池**：V1.1 允许翻前多人入池；但翻牌关键点建议选择"与单一对手的可解释节点"。若多人导致无法稳定生成关键点：
  - 方案：翻牌关键点生成器优先挑选"Hero vs 单人下注者"情形；否则直接快进并只做翻前复盘
- **断线/刷新**：通过 `handId` 恢复（`GET /review` 或 `GET /state`）
- **随机一致性**：所有采样基于 `handSeed`，保证重打复现

---

## 14. 验收标准（Definition of Done）

功能正确性：
- 6max 行动顺序正确（按钮位、盲注、翻前从 UTG 开始等）
- 所有动作按钮只在合法时出现
- 翻牌下注尺度 33/75/125% 计算正确且满足最小下注/加注
- 一局能稳定产出翻牌关键点复盘（目标 ≥ 85%）

产品体验：
- 单局耗时（快速模式）目标：15–40 秒/局（视是否进入翻牌）
- 复盘信息"以频率为主"，且 Free/Pro 展示差异符合权益

数据与权限：
- Free 局数额度生效、Pro 无限生效
- 埋点链路完整（start→action→end→review）

---

## 15. 里程碑建议（供排期）

- M1：牌局引擎状态机 + 翻前对手策略接入 + 结算（无翻牌训练）
- M2：翻牌关键点生成 + 3 尺度按钮 + 翻牌策略与评分 + 复盘页
- M3：快进引擎 + 重打同一手（Pro）+ 埋点与看板

---

## 16. 版本后续展望（不属于 V1.1 交付）
- V1.2：翻牌专项训练（从 `flop_context_id` 抽题），与完整牌局弱点联动
- V1.3：版本 B（多街决策），或先覆盖 SRP（BTN vs BB）到 Turn/River
- V1.4：更细的池型库（3BP IP/OOP）与更接近 solver 的频率表

---

以上即本次模块更新的**完整 PRD**（按你确定的 A / 6max / 3 尺度 / 数据化频率）。
